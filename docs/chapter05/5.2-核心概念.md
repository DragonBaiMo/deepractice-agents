# 5.2 æ ¸å¿ƒæ¦‚å¿µï¼šäº‹ä»¶ç³»ç»Ÿä¸çŠ¶æ€æœº

ä¸Šä¸€èŠ‚ä»‹ç»äº†è®¾è®¡å“²å­¦ï¼Œæœ¬èŠ‚æ·±å…¥å‰–æä¸¤å¤§æ ¸å¿ƒï¼š**å››å±‚äº‹ä»¶ç³»ç»Ÿ** å’Œ **Mealy çŠ¶æ€æœº**ã€‚ç†è§£å®ƒä»¬æ˜¯æŒæ¡ AgentX çš„å…³é”®ã€‚

---

## å››å±‚äº‹ä»¶ç³»ç»Ÿ

AgentX å°†æ‰§è¡Œè¿‡ç¨‹æŠ½è±¡ä¸ºå››å±‚äº‹ä»¶ï¼Œä»åº•å±‚çš„æµå¼è¾“å‡ºåˆ°é¡¶å±‚çš„å®Œæ•´è½®æ¬¡ã€‚

### äº‹ä»¶å±‚æ¬¡æ¦‚è§ˆ

<div align="center">
<p>è¡¨ 5.2 AgentX å››å±‚äº‹ä»¶ç³»ç»Ÿ</p>
</div>

| å±‚çº§ | åç§° | èŒè´£ | ç²’åº¦ |
|-----|------|------|------|
| **Layer 1** | Stream Level | å¤„ç† LLM çš„æµå¼è¾“å‡º | Token çº§åˆ« |
| **Layer 2** | State Level | ç®¡ç†æ™ºèƒ½ä½“çŠ¶æ€è½¬æ¢ | çŠ¶æ€çº§åˆ« |
| **Layer 3** | Message Level | å¤„ç†ç”¨æˆ·å’Œç³»ç»Ÿæ¶ˆæ¯ | æ¶ˆæ¯çº§åˆ« |
| **Layer 4** | Turn Level | ç®¡ç†å®Œæ•´çš„å¯¹è¯è½®æ¬¡ | è½®æ¬¡çº§åˆ« |

### Layer 1ï¼šStream Levelï¼ˆæµäº‹ä»¶å±‚ï¼‰

æµäº‹ä»¶å±‚å¤„ç† LLM çš„æµå¼å“åº”ã€‚åœ¨å¤§æ¨¡å‹æ—¶ä»£ï¼Œæµå¼è¾“å‡ºå·²æˆä¸ºæ ‡å‡†åšæ³•ï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨æ¨¡å‹ç”Ÿæˆè¿‡ç¨‹ä¸­å°±èƒ½çœ‹åˆ°éƒ¨åˆ†ç»“æœã€‚

```typescript
// æµäº‹ä»¶ç¤ºä¾‹
interface StreamEvent {
  type: 'stream:token' | 'stream:start' | 'stream:end';
  token?: string;      // å½“å‰ç”Ÿæˆçš„ token
  accumulated?: string; // ç´¯ç§¯çš„æ–‡æœ¬
  timestamp: number;
}

// ç›‘å¬æµäº‹ä»¶
agent.on('stream:token', (event) => {
  process.stdout.write(event.token);  // å®æ—¶æ˜¾ç¤ºç”Ÿæˆå†…å®¹
});

agent.on('stream:end', (event) => {
  console.log('\nç”Ÿæˆå®Œæˆï¼Œå…±', event.accumulated.length, 'å­—ç¬¦');
});
```

**æµäº‹ä»¶çš„åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|-----|------|
| å®æ—¶æ˜¾ç¤º | åœ¨ UI ä¸Šé€å­—æ˜¾ç¤ºç”Ÿæˆå†…å®¹ |
| å†…å®¹è¿‡æ»¤ | æ£€æµ‹æ•æ„Ÿè¯å¹¶åŠæ—¶ä¸­æ–­ |
| è¿›åº¦ç›‘æ§ | ä¼°ç®—å‰©ä½™ç”Ÿæˆæ—¶é—´ |
| æˆæœ¬æ§åˆ¶ | åœ¨ token è¶…é™å‰ç»ˆæ­¢ |

### Layer 2ï¼šState Levelï¼ˆçŠ¶æ€äº‹ä»¶å±‚ï¼‰

çŠ¶æ€äº‹ä»¶å±‚ç®¡ç†æ™ºèƒ½ä½“çš„çŠ¶æ€è½¬æ¢ã€‚æ¯å½“æ™ºèƒ½ä½“ä»ä¸€ä¸ªçŠ¶æ€è½¬ç§»åˆ°å¦ä¸€ä¸ªçŠ¶æ€æ—¶ï¼Œéƒ½ä¼šè§¦å‘ç›¸åº”çš„äº‹ä»¶ã€‚

```typescript
// çŠ¶æ€äº‹ä»¶ç¤ºä¾‹
interface StateEvent {
  type: 'state:change';
  from: AgentState;    // åŸçŠ¶æ€
  to: AgentState;      // æ–°çŠ¶æ€
  trigger: string;     // è§¦å‘è½¬æ¢çš„åŠ¨ä½œ
  timestamp: number;
}

// AgentX å®šä¹‰çš„çŠ¶æ€
enum AgentState {
  CREATED = 'created',
  RUNNING = 'running',
  THINKING = 'thinking',
  ACTING = 'acting',
  WAITING = 'waiting',
  PAUSED = 'paused',
  COMPLETED = 'completed',
  ERROR = 'error'
}

// ç›‘å¬çŠ¶æ€å˜åŒ–
agent.on('state:change', (event) => {
  console.log(`çŠ¶æ€è½¬æ¢: ${event.from} â†’ ${event.to}`);

  // è®°å½•çŠ¶æ€å˜åŒ–å†å²
  stateHistory.push({
    from: event.from,
    to: event.to,
    time: event.timestamp
  });
});
```

**çŠ¶æ€äº‹ä»¶çš„åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|-----|------|
| çŠ¶æ€è¿½è¸ª | è®°å½•å®Œæ•´çš„çŠ¶æ€è½¬æ¢å†å² |
| è¶…æ—¶æ§åˆ¶ | åœ¨æŸçŠ¶æ€åœç•™è¿‡ä¹…æ—¶è§¦å‘å‘Šè­¦ |
| èµ„æºç®¡ç† | è¿›å…¥ç‰¹å®šçŠ¶æ€æ—¶åˆ†é…/é‡Šæ”¾èµ„æº |
| è°ƒè¯•åˆ†æ | åˆ†æçŠ¶æ€è½¬æ¢æ˜¯å¦ç¬¦åˆé¢„æœŸ |

### Layer 3ï¼šMessage Levelï¼ˆæ¶ˆæ¯äº‹ä»¶å±‚ï¼‰

æ¶ˆæ¯äº‹ä»¶å±‚å¤„ç†æ™ºèƒ½ä½“ä¸å¤–éƒ¨ä¸–ç•Œçš„æ¶ˆæ¯äº¤äº’ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¾“å…¥ã€ç³»ç»ŸæŒ‡ä»¤ã€å·¥å…·è¿”å›ç­‰ã€‚

```typescript
// æ¶ˆæ¯äº‹ä»¶ç¤ºä¾‹
interface MessageEvent {
  type: 'message:user' | 'message:assistant' | 'message:system' | 'message:tool';
  role: 'user' | 'assistant' | 'system' | 'tool';
  content: string;
  metadata?: {
    toolName?: string;
    toolResult?: any;
  };
  timestamp: number;
}

// ç›‘å¬ä¸åŒç±»å‹çš„æ¶ˆæ¯
agent.on('message:user', (event) => {
  console.log(`ç”¨æˆ·: ${event.content}`);
});

agent.on('message:assistant', (event) => {
  console.log(`åŠ©æ‰‹: ${event.content}`);
});

agent.on('message:tool', (event) => {
  console.log(`å·¥å…·[${event.metadata.toolName}]: ${event.content}`);
});
```

**æ¶ˆæ¯äº‹ä»¶çš„åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|-----|------|
| å¯¹è¯æ—¥å¿— | è®°å½•å®Œæ•´çš„å¯¹è¯å†å² |
| å†…å®¹å®¡æ ¸ | å¯¹ç”¨æˆ·è¾“å…¥å’Œæ¨¡å‹è¾“å‡ºè¿›è¡Œå®‰å…¨æ£€æŸ¥ |
| æ¶ˆæ¯è½¬æ¢ | åœ¨æ¶ˆæ¯å‘é€å‰è¿›è¡Œæ ¼å¼è½¬æ¢ |
| å¤šæ¸ é“é€‚é… | åŒä¸€æ¶ˆæ¯å‘é€åˆ°ä¸åŒå¹³å° |

### Layer 4ï¼šTurn Levelï¼ˆè½®æ¬¡äº‹ä»¶å±‚ï¼‰

è½®æ¬¡äº‹ä»¶å±‚ç®¡ç†å®Œæ•´çš„äº¤äº’è½®æ¬¡ã€‚åœ¨ ReAct èŒƒå¼ä¸­ï¼Œä¸€ä¸ªè½®æ¬¡åŒ…å«ã€Œæ€è€ƒ â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿã€çš„å®Œæ•´å¾ªç¯ã€‚

```typescript
// è½®æ¬¡äº‹ä»¶ç¤ºä¾‹
interface TurnEvent {
  type: 'turn:start' | 'turn:end';
  turnIndex: number;   // ç¬¬å‡ è½®
  thought?: string;    // æ€è€ƒå†…å®¹
  action?: {
    tool: string;
    input: any;
  };
  observation?: string; // è§‚å¯Ÿç»“æœ
  duration: number;    // è€—æ—¶(ms)
}

// ç›‘å¬è½®æ¬¡äº‹ä»¶
agent.on('turn:start', (event) => {
  console.log(`\n===== ç¬¬ ${event.turnIndex + 1} è½® =====`);
});

agent.on('turn:end', (event) => {
  console.log(`æ€è€ƒ: ${event.thought}`);
  if (event.action) {
    console.log(`è¡ŒåŠ¨: ${event.action.tool}(${JSON.stringify(event.action.input)})`);
    console.log(`è§‚å¯Ÿ: ${event.observation}`);
  }
  console.log(`è€—æ—¶: ${event.duration}ms`);
});
```

**è½®æ¬¡äº‹ä»¶çš„åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|-----|------|
| è½®æ¬¡é™åˆ¶ | æ§åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯ |
| æ€§èƒ½åˆ†æ | ç»Ÿè®¡æ¯è½®è€—æ—¶ï¼Œè¯†åˆ«ç“¶é¢ˆ |
| æ–­ç‚¹æ¢å¤ | ä¿å­˜è½®æ¬¡çŠ¶æ€ï¼Œæ”¯æŒä¸­æ–­åç»§ç»­ |
| å¯è§†åŒ–å±•ç¤º | åœ¨ UI ä¸Šåˆ†æ­¥å±•ç¤ºæ‰§è¡Œè¿‡ç¨‹ |

### å››å±‚äº‹ä»¶çš„åä½œå…³ç³»

å››å±‚äº‹ä»¶å¹¶éå­¤ç«‹å­˜åœ¨ï¼Œè€Œæ˜¯ç›¸äº’åä½œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Turn Level                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Message Level                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              State Level                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚         Stream Level            â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                 â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  token â†’ token â†’ token â†’ ...   â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                 â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  THINKING â†’ ACTING â†’ WAITING           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  [user] â†’ [assistant] â†’ [tool] â†’ [assistant]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  Turn 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº‹ä»¶è§¦å‘é¡ºåºç¤ºä¾‹**ï¼š

```
1. turn:start        (å¼€å§‹ç¬¬1è½®)
2. state:change      (RUNNING â†’ THINKING)
3. stream:start      (å¼€å§‹æµå¼è¾“å‡º)
4. stream:token Ã— N  (é€ä¸ª token è¾“å‡º)
5. stream:end        (æµå¼è¾“å‡ºç»“æŸ)
6. message:assistant (å®Œæ•´çš„æ€è€ƒå†…å®¹)
7. state:change      (THINKING â†’ ACTING)
8. message:tool      (å·¥å…·æ‰§è¡Œç»“æœ)
9. state:change      (ACTING â†’ WAITING)
10. turn:end         (ç»“æŸç¬¬1è½®)
```

---

## Mealy çŠ¶æ€æœºæ¨¡å‹

AgentX ä½¿ç”¨ **Mealy çŠ¶æ€æœº** æ¥ç®¡ç†æ™ºèƒ½ä½“çš„ç”Ÿå‘½å‘¨æœŸã€‚Mealy çŠ¶æ€æœºæ˜¯ä¸€ç§æœ‰é™çŠ¶æ€æœºï¼Œå…¶ç‰¹ç‚¹æ˜¯è¾“å‡ºä¸ä»…å–å†³äºå½“å‰çŠ¶æ€ï¼Œè¿˜å–å†³äºè¾“å…¥ã€‚

### ä»€ä¹ˆæ˜¯ Mealy çŠ¶æ€æœº

åœ¨è‡ªåŠ¨æœºç†è®ºä¸­ï¼Œæœ‰ä¸¤ç§ç»å…¸çš„æœ‰é™çŠ¶æ€æœºï¼š

| ç±»å‹ | è¾“å‡ºä¾èµ– | ç‰¹ç‚¹ |
|-----|---------|------|
| **Moore çŠ¶æ€æœº** | ä»…ä¾èµ–å½“å‰çŠ¶æ€ | è¾“å‡ºç®€å•ï¼Œä½†çŠ¶æ€æ•°é‡å¯èƒ½è¾ƒå¤š |
| **Mealy çŠ¶æ€æœº** | ä¾èµ–å½“å‰çŠ¶æ€ + è¾“å…¥ | çŠ¶æ€æ•°é‡è¾ƒå°‘ï¼Œå“åº”æ›´åŠæ—¶ |

AgentX é€‰æ‹© Mealy çŠ¶æ€æœºçš„åŸå› ï¼š

1. **çŠ¶æ€ç²¾ç®€**ï¼šç›¸åŒåŠŸèƒ½æ‰€éœ€çš„çŠ¶æ€æ•°é‡æ›´å°‘
2. **å“åº”åŠæ—¶**ï¼šçŠ¶æ€è½¬æ¢æ—¶ç«‹å³äº§ç”Ÿè¾“å‡ºï¼Œæ— éœ€ç­‰å¾…
3. **çµæ´»æ€§é«˜**ï¼šåŒä¸€çŠ¶æ€å¯æ ¹æ®ä¸åŒè¾“å…¥äº§ç”Ÿä¸åŒè¾“å‡º

### AgentX çš„çŠ¶æ€å®šä¹‰

AgentX å®šä¹‰äº†ä»¥ä¸‹æ ¸å¿ƒçŠ¶æ€ï¼š

```typescript
enum AgentState {
  // ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
  CREATED = 'created',     // å·²åˆ›å»ºï¼Œå°šæœªå¯åŠ¨
  RUNNING = 'running',     // è¿è¡Œä¸­
  PAUSED = 'paused',       // å·²æš‚åœ
  COMPLETED = 'completed', // å·²å®Œæˆ
  ERROR = 'error',         // å‡ºé”™

  // è¿è¡Œæ—¶å­çŠ¶æ€ï¼ˆRUNNING çš„ç»†åˆ†ï¼‰
  THINKING = 'thinking',   // æ€è€ƒä¸­
  ACTING = 'acting',       // æ‰§è¡Œå·¥å…·ä¸­
  WAITING = 'waiting'      // ç­‰å¾…è¾“å…¥ä¸­
}
```

### çŠ¶æ€è½¬æ¢è§„åˆ™

AgentX çš„çŠ¶æ€è½¬æ¢éµå¾ªä¸¥æ ¼çš„è§„åˆ™ï¼Œé˜²æ­¢éæ³•æ“ä½œï¼š

```typescript
// çŠ¶æ€è½¬æ¢è§„åˆ™å®šä¹‰
const transitions: StateTransition[] = [
  // ä» CREATED çŠ¶æ€
  { from: 'created', to: 'running', trigger: 'start' },
  { from: 'created', to: 'error', trigger: 'error' },

  // ä» RUNNING çŠ¶æ€
  { from: 'running', to: 'thinking', trigger: 'think' },
  { from: 'running', to: 'paused', trigger: 'pause' },
  { from: 'running', to: 'completed', trigger: 'finish' },
  { from: 'running', to: 'error', trigger: 'error' },

  // ä» THINKING çŠ¶æ€
  { from: 'thinking', to: 'acting', trigger: 'act' },
  { from: 'thinking', to: 'completed', trigger: 'finish' },
  { from: 'thinking', to: 'error', trigger: 'error' },

  // ä» ACTING çŠ¶æ€
  { from: 'acting', to: 'waiting', trigger: 'wait' },
  { from: 'acting', to: 'thinking', trigger: 'think' },
  { from: 'acting', to: 'error', trigger: 'error' },

  // ä» WAITING çŠ¶æ€
  { from: 'waiting', to: 'thinking', trigger: 'think' },
  { from: 'waiting', to: 'completed', trigger: 'finish' },

  // ä» PAUSED çŠ¶æ€
  { from: 'paused', to: 'running', trigger: 'resume' },
  { from: 'paused', to: 'completed', trigger: 'stop' },
];
```

### çŠ¶æ€è½¬æ¢å›¾

```
                         create()
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”Œâ”€â”€â”€â”€â”€â”€â†’â”‚   CREATED    â”‚â†â”€â”€â”€â”€â”€â”€â”
           â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
           â”‚              â”‚ start()       â”‚
           â”‚              â–¼               â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
           â”‚   â”‚      RUNNING       â”‚     â”‚
           â”‚   â”‚                    â”‚     â”‚
  destroy()â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ error()
           â”‚   â”‚  â”‚   THINKING   â”‚ â”‚     â”‚
           â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
           â”‚   â”‚          â”‚ act()  â”‚     â”‚
           â”‚   â”‚          â–¼        â”‚     â”‚
           â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
           â”‚   â”‚  â”‚    ACTING    â”‚ â”‚     â”‚
           â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
           â”‚   â”‚          â”‚ wait() â”‚     â”‚
           â”‚   â”‚          â–¼        â”‚     â”‚
           â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
           â”‚   â”‚  â”‚   WAITING    â”‚ â”‚     â”‚
           â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
           â”‚   â”‚                    â”‚     â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
           â”‚             â”‚                â”‚
           â”‚    pause()  â”‚  finish()      â”‚
           â”‚       â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”          â”‚
           â”‚       â–¼           â–¼          â”‚
           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
           â””â”€â”‚  PAUSED  â”‚ â”‚COMPLETED â”‚â”€â”€â”€â”€â”˜
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚            â”‚
                   â”‚ resume()   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æœºçš„å®ç°

AgentX çš„çŠ¶æ€æœºå®ç°ï¼š

```typescript
class StateMachine {
  private state: AgentState;
  private transitions: Map<string, StateTransition>;
  private listeners: Map<string, Function[]>;

  constructor(initialState: AgentState) {
    this.state = initialState;
    this.transitions = new Map();
    this.listeners = new Map();
  }

  // æ³¨å†ŒçŠ¶æ€è½¬æ¢è§„åˆ™
  addTransition(from: AgentState, to: AgentState, trigger: string) {
    const key = `${from}:${trigger}`;
    this.transitions.set(key, { from, to, trigger });
  }

  // è§¦å‘çŠ¶æ€è½¬æ¢
  trigger(action: string): boolean {
    const key = `${this.state}:${action}`;
    const transition = this.transitions.get(key);

    if (!transition) {
      console.warn(`éæ³•è½¬æ¢: æ— æ³•ä» ${this.state} é€šè¿‡ ${action} è½¬æ¢`);
      return false;
    }

    const prevState = this.state;
    this.state = transition.to;

    // è§¦å‘çŠ¶æ€å˜åŒ–äº‹ä»¶
    this.emit('state:change', {
      from: prevState,
      to: this.state,
      trigger: action,
      timestamp: Date.now()
    });

    return true;
  }

  // è·å–å½“å‰çŠ¶æ€
  getState(): AgentState {
    return this.state;
  }

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡ŒæŸä¸ªåŠ¨ä½œ
  canTrigger(action: string): boolean {
    const key = `${this.state}:${action}`;
    return this.transitions.has(key);
  }
}
```

### çŠ¶æ€æœºçš„åº”ç”¨ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šåŸºæœ¬çŠ¶æ€æ§åˆ¶**

```typescript
const agent = new Agent();

// æ£€æŸ¥å½“å‰çŠ¶æ€
console.log(agent.state); // 'created'

// å¯åŠ¨æ™ºèƒ½ä½“
agent.start();
console.log(agent.state); // 'running'

// å°è¯•éæ³•æ“ä½œ
agent.pause();  // å¯ä»¥æš‚åœ
agent.start();  // é”™è¯¯ï¼å·²æš‚åœçš„æ™ºèƒ½ä½“ä¸èƒ½ç›´æ¥ startï¼Œåº”è¯¥ resume
```

**ç¤ºä¾‹ 2ï¼šæš‚åœä¸æ¢å¤**

```typescript
const agent = new Agent();
agent.start();

// å¼€å§‹æ‰§è¡Œä»»åŠ¡
const task = agent.run('åˆ†æè¿™ç¯‡æ–‡ç« çš„ä¸»è¦è§‚ç‚¹');

// ç”¨æˆ·ä¸­æ–­
agent.pause();
console.log(agent.state); // 'paused'

// ç¨åæ¢å¤
setTimeout(() => {
  agent.resume();
  // ç»§ç»­æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡
}, 5000);
```

**ç¤ºä¾‹ 3ï¼šé”™è¯¯å¤„ç†**

```typescript
agent.on('state:change', (event) => {
  if (event.to === 'error') {
    // è®°å½•é”™è¯¯æ—¥å¿—
    logger.error(`æ™ºèƒ½ä½“å‡ºé”™: ${event.error}`);

    // å°è¯•æ¢å¤
    if (canRecover(event.error)) {
      agent.recover();
    } else {
      // é€šçŸ¥ç”¨æˆ·
      notifyUser('ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
});
```

---

## äº‹ä»¶ä¸çŠ¶æ€çš„ååŒ

äº‹ä»¶ç³»ç»Ÿå’ŒçŠ¶æ€æœºåœ¨ AgentX ä¸­ç´§å¯†åä½œï¼š

1. **çŠ¶æ€è½¬æ¢è§¦å‘äº‹ä»¶**ï¼šæ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½ä¼šå‘å‡º `state:change` äº‹ä»¶
2. **äº‹ä»¶å¯èƒ½è§¦å‘çŠ¶æ€è½¬æ¢**ï¼šæŸäº›äº‹ä»¶ï¼ˆå¦‚é”™è¯¯ã€è¶…æ—¶ï¼‰ä¼šå¯¼è‡´çŠ¶æ€å˜åŒ–
3. **çŠ¶æ€å†³å®šå¯ç›‘å¬çš„äº‹ä»¶**ï¼šåªæœ‰åœ¨ç‰¹å®šçŠ¶æ€ä¸‹æ‰ä¼šè§¦å‘æŸäº›äº‹ä»¶

```typescript
// çŠ¶æ€ä¸äº‹ä»¶çš„ååŒç¤ºä¾‹
class Agent {
  private stateMachine: StateMachine;
  private eventBus: EventBus;

  async think(prompt: string) {
    // 1. æ£€æŸ¥çŠ¶æ€æ˜¯å¦å…è®¸æ€è€ƒ
    if (!this.stateMachine.canTrigger('think')) {
      throw new Error(`å½“å‰çŠ¶æ€ ${this.stateMachine.getState()} ä¸å…è®¸æ€è€ƒ`);
    }

    // 2. çŠ¶æ€è½¬æ¢
    this.stateMachine.trigger('think');

    // 3. å‘å‡ºæµäº‹ä»¶
    this.eventBus.emit('stream:start', { timestamp: Date.now() });

    // 4. æ‰§è¡Œå®é™…çš„æ€è€ƒé€»è¾‘
    for await (const token of this.llm.stream(prompt)) {
      this.eventBus.emit('stream:token', { token, timestamp: Date.now() });
    }

    // 5. å‘å‡ºç»“æŸäº‹ä»¶
    this.eventBus.emit('stream:end', { timestamp: Date.now() });
  }
}
```

---

## æœ¬èŠ‚å°ç»“

æœ¬èŠ‚ä»‹ç»äº† AgentX çš„ä¸¤å¤§æ ¸å¿ƒï¼š

1. **å››å±‚äº‹ä»¶ç³»ç»Ÿ**ï¼šStreamï¼ˆæµå¼è¾“å‡ºï¼‰ã€Stateï¼ˆçŠ¶æ€è½¬æ¢ï¼‰ã€Messageï¼ˆæ¶ˆæ¯äº¤äº’ï¼‰ã€Turnï¼ˆå®Œæ•´è½®æ¬¡ï¼‰
2. **Mealy çŠ¶æ€æœº**ï¼šå®šä¹‰ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ã€è§„å®šè½¬æ¢è·¯å¾„ã€æä¾›å¯é¢„æµ‹çš„è¡Œä¸ºæ¨¡å¼

ç†è§£åä½ å°†èƒ½å¤Ÿï¼š
- ç›‘å¬å’Œå¤„ç†å„å±‚çº§äº‹ä»¶
- ç†è§£çŠ¶æ€è½¬æ¢é€»è¾‘
- å®ç°å¤æ‚æ§åˆ¶æµç¨‹

ä¸‹ä¸€èŠ‚åŠ¨æ‰‹å®è·µï¼Œåˆ›å»ºç¬¬ä¸€ä¸ª AgentX æ™ºèƒ½ä½“ã€‚

---

[â¬…ï¸ ä¸Šä¸€èŠ‚ï¼šAgentX ç®€ä»‹](5.1-AgentXç®€ä»‹ä¸è®¾è®¡å“²å­¦.md) | [ğŸ  è¿”å›ç›®å½•](README.md) | [â¡ï¸ ä¸‹ä¸€èŠ‚ï¼šå¿«é€Ÿå¼€å§‹](5.3-å¿«é€Ÿå¼€å§‹.md)
