# 5.3 快速开始：第一个 AgentX 智能体

前两节学完理论，现在动手实践。本节从零开始创建第一个 AgentX 智能体，体验框架的简洁与强大。

---

## 环境准备

### 安装 Node.js

AgentX 基于 TypeScript 开发，需要 Node.js 运行环境。推荐使用 Node.js 18 或更高版本。

```bash
# 检查 Node.js 版本
node --version  # 应该 >= 18.0.0

# 如果未安装，使用 nvm 安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18
```

### 创建项目

```bash
# 创建项目目录
mkdir my-first-agent
cd my-first-agent

# 初始化项目
npm init -y

# 安装 AgentX
npm install @anthropic/agentx

# 安装 TypeScript（可选，但推荐）
npm install -D typescript ts-node @types/node
npx tsc --init
```

### 配置环境变量

创建 `.env` 文件，配置 LLM API 密钥：

```bash
# .env
OPENAI_API_KEY=sk-your-api-key
# 或使用其他 LLM
ANTHROPIC_API_KEY=your-anthropic-key
```

---

## Hello AgentX

让我们从最简单的例子开始：

### 创建第一个智能体

创建文件 `hello-agent.ts`：

```typescript
import { Agent } from '@anthropic/agentx';

// 创建智能体实例
const agent = new Agent({
  name: 'HelloAgent',
  model: 'gpt-4',
  systemPrompt: '你是一个友好的助手，用简洁的语言回答问题。'
});

// 运行智能体
async function main() {
  const response = await agent.run('你好，请介绍一下你自己。');
  console.log(response);
}

main();
```

运行：

```bash
npx ts-node hello-agent.ts
```

输出示例：

```
你好！我是 HelloAgent，一个基于 AgentX 框架的智能助手。
我可以帮你回答问题、执行任务、进行对话。有什么我可以帮助你的吗？
```

### 代码解析

这段代码虽然简单，但展示了 AgentX 的核心特性：

| 代码 | 说明 |
|-----|------|
| `new Agent({...})` | 创建智能体实例，配置名称、模型和系统提示词 |
| `agent.run(prompt)` | 运行智能体，传入用户提示，返回响应 |

与第四章的手写实现相比，不需要：
- 手动管理消息历史
- 编写循环逻辑
- 处理流式输出
- 解析模型输出

这些都由 AgentX 框架自动处理。

---

## 添加事件监听

AgentX 的强大之处在于其事件系统。让我们为智能体添加事件监听：

```typescript
import { Agent } from '@anthropic/agentx';

const agent = new Agent({
  name: 'EventfulAgent',
  model: 'gpt-4'
});

// 监听流式输出
agent.on('stream:token', (event) => {
  process.stdout.write(event.token);  // 实时显示
});

// 监听状态变化
agent.on('state:change', (event) => {
  console.log(`\n[状态] ${event.from} → ${event.to}`);
});

// 监听消息
agent.on('message:assistant', (event) => {
  console.log(`\n[助手消息] 长度: ${event.content.length} 字符`);
});

async function main() {
  console.log('开始运行...\n');
  await agent.run('请用三句话介绍人工智能的发展历程。');
  console.log('\n运行结束');
}

main();
```

输出示例：

```
开始运行...

[状态] created → running
[状态] running → thinking

人工智能的概念诞生于1956年的达特茅斯会议，
[状态] thinking → completed
标志着这一学科的正式建立。经过几次"寒冬"后，
深度学习的突破在2010年代引发了AI的复兴。
如今，大语言模型的出现正在开启通用人工智能的新纪元。

[助手消息] 长度: 128 字符
运行结束
```

---

## 实现 ReAct 智能体

现在，让我们实现一个带工具调用的 ReAct 智能体。回忆第四章的手写实现需要上百行代码，而在 AgentX 中：

```typescript
import { Agent, Tool, react } from '@anthropic/agentx';

// 定义搜索工具
const searchTool = Tool.define({
  name: 'search',
  description: '搜索网络获取最新信息',
  parameters: {
    query: {
      type: 'string',
      description: '搜索关键词'
    }
  },
  execute: async ({ query }) => {
    // 实际项目中应调用真实的搜索 API
    console.log(`[工具调用] 搜索: ${query}`);

    // 模拟搜索结果
    return `搜索"${query}"的结果：这是一些相关信息...`;
  }
});

// 定义计算器工具
const calculatorTool = Tool.define({
  name: 'calculator',
  description: '执行数学计算',
  parameters: {
    expression: {
      type: 'string',
      description: '数学表达式，如 "2 + 3 * 4"'
    }
  },
  execute: async ({ expression }) => {
    console.log(`[工具调用] 计算: ${expression}`);
    try {
      // 注意：实际项目中应使用安全的数学表达式解析库
      const result = eval(expression);
      return `${expression} = ${result}`;
    } catch (error) {
      return `计算错误: ${error.message}`;
    }
  }
});

// 创建 ReAct 智能体
const agent = react({
  name: 'ReActAgent',
  model: 'gpt-4',
  tools: [searchTool, calculatorTool],
  maxIterations: 5  // 最多执行5轮
});

// 监听轮次事件
agent.on('turn:end', (event) => {
  console.log(`\n--- 第 ${event.turnIndex + 1} 轮 ---`);
  console.log(`思考: ${event.thought}`);
  if (event.action) {
    console.log(`行动: ${event.action.tool}(${JSON.stringify(event.action.input)})`);
    console.log(`观察: ${event.observation}`);
  }
});

async function main() {
  const result = await agent.run(
    '帮我计算一下：如果我有1000元，年利率是5%，3年后本息合计是多少？'
  );

  console.log('\n===== 最终答案 =====');
  console.log(result);
}

main();
```

输出示例：

```
--- 第 1 轮 ---
思考: 用户想计算复利。复利公式是 A = P(1 + r)^n，其中 P=1000，r=0.05，n=3。
      我需要使用计算器来计算 1000 * (1 + 0.05)^3。
行动: calculator({"expression": "1000 * Math.pow(1.05, 3)"})
[工具调用] 计算: 1000 * Math.pow(1.05, 3)
观察: 1000 * Math.pow(1.05, 3) = 1157.625

--- 第 2 轮 ---
思考: 我已经得到了计算结果。1000元按5%年利率计算，3年后本息合计为1157.625元。
      现在可以给用户完整的答案了。

===== 最终答案 =====
根据复利计算公式 A = P(1 + r)^n：
- 本金 P = 1000 元
- 年利率 r = 5% = 0.05
- 年数 n = 3 年

计算结果：1000 × (1 + 0.05)³ = 1000 × 1.157625 = **1157.63 元**

所以，3年后您的本息合计为 **1157.63 元**，其中利息收益为 157.63 元。
```

### 与第四章手写实现的对比

<div align="center">
<p>表 5.3 ReAct 实现对比</p>
</div>

| 方面 | 第四章手写实现 | AgentX 实现 |
|-----|--------------|-------------|
| **代码量** | ~150 行 | ~50 行 |
| **工具定义** | 字典 + 函数映射 | 声明式 `Tool.define` |
| **循环控制** | 手动 while 循环 | 框架自动管理 |
| **输出解析** | 正则表达式 | 框架自动解析 |
| **错误处理** | 基本无 | 内置重试和降级 |
| **可观测性** | 需手动添加日志 | 事件系统自动支持 |

---

## 实现 Plan-and-Solve 智能体

AgentX 也支持 Plan-and-Solve 范式：

```typescript
import { Agent, planAndSolve } from '@anthropic/agentx';

// 创建 Plan-and-Solve 智能体
const agent = planAndSolve({
  name: 'PlannerAgent',
  model: 'gpt-4',
  plannerPrompt: `你是一个专业的任务规划师。
请将用户的任务分解为清晰、可执行的步骤。
每个步骤应该是具体的、可验证的。`,
  executorPrompt: `你是一个认真的任务执行者。
请按照给定的计划，逐步执行每个任务。
完成每个步骤后，报告执行结果。`
});

// 监听规划事件
agent.on('plan:generated', (event) => {
  console.log('===== 生成的计划 =====');
  event.steps.forEach((step, i) => {
    console.log(`${i + 1}. ${step}`);
  });
  console.log('====================\n');
});

// 监听步骤执行事件
agent.on('step:completed', (event) => {
  console.log(`✓ 步骤 ${event.stepIndex + 1} 完成: ${event.result}`);
});

async function main() {
  const result = await agent.run(
    '请帮我写一篇关于"人工智能在医疗领域应用"的500字文章'
  );

  console.log('\n===== 最终结果 =====');
  console.log(result);
}

main();
```

---

## 实现 Reflection 智能体

同样，Reflection 范式也只需要简单配置：

```typescript
import { Agent, reflection } from '@anthropic/agentx';

// 创建 Reflection 智能体
const agent = reflection({
  name: 'ReflectiveAgent',
  model: 'gpt-4',
  generatorPrompt: '你是一个代码生成专家，请根据需求生成高质量的代码。',
  criticPrompt: `你是一个严格的代码评审专家。
请从以下角度评审代码：
1. 正确性：代码是否能正确实现需求
2. 效率：是否存在性能问题
3. 可读性：代码是否清晰易懂
4. 健壮性：是否处理了边界情况

如果代码已经足够好，请回复"**无需改进**"。
否则，请具体指出问题并给出改进建议。`,
  maxIterations: 3
});

// 监听迭代事件
agent.on('iteration:end', (event) => {
  console.log(`\n--- 第 ${event.iteration + 1} 次迭代 ---`);
  console.log(`生成:\n${event.generation.substring(0, 200)}...`);
  console.log(`\n评审: ${event.critique.substring(0, 200)}...`);
});

async function main() {
  const result = await agent.run(
    '请用 Python 实现一个函数，判断一个数是否为质数'
  );

  console.log('\n===== 最终代码 =====');
  console.log(result);
}

main();
```

---

## 配置选项详解

AgentX 提供了丰富的配置选项：

```typescript
const agent = new Agent({
  // 基础配置
  name: 'MyAgent',           // 智能体名称
  model: 'gpt-4',            // 使用的模型
  systemPrompt: '...',       // 系统提示词

  // 模型配置
  modelConfig: {
    temperature: 0.7,        // 温度参数
    maxTokens: 2000,         // 最大生成长度
    topP: 0.9,               // Top-P 采样
    frequencyPenalty: 0,     // 频率惩罚
    presencePenalty: 0       // 存在惩罚
  },

  // 执行配置
  maxIterations: 10,         // 最大迭代次数
  timeout: 60000,            // 超时时间(ms)

  // 重试配置
  retry: {
    maxAttempts: 3,          // 最大重试次数
    backoff: 'exponential',  // 退避策略
    initialDelay: 1000       // 初始延迟(ms)
  },

  // 记忆配置
  memory: {
    type: 'buffer',          // 记忆类型
    maxMessages: 20          // 最大消息数
  },

  // 日志配置
  logging: {
    level: 'info',           // 日志级别
    format: 'json'           // 日志格式
  }
});
```

---

## 错误处理

AgentX 提供了完善的错误处理机制：

```typescript
import { Agent, AgentError, ToolError, TimeoutError } from '@anthropic/agentx';

const agent = new Agent({ ... });

// 方式一：try-catch
async function runWithTryCatch() {
  try {
    const result = await agent.run('...');
    return result;
  } catch (error) {
    if (error instanceof TimeoutError) {
      console.error('执行超时:', error.message);
    } else if (error instanceof ToolError) {
      console.error('工具执行失败:', error.toolName, error.message);
    } else if (error instanceof AgentError) {
      console.error('智能体错误:', error.message);
    } else {
      console.error('未知错误:', error);
    }
  }
}

// 方式二：事件监听
agent.on('error', (event) => {
  console.error('发生错误:', event.error);

  // 可以选择恢复执行
  if (event.recoverable) {
    agent.recover();
  }
});
```

---

## 本节小结

本节演示了 AgentX 的使用：

1. **环境准备**：安装 Node.js 和 AgentX
2. **基础用法**：创建并运行智能体
3. **事件监听**：监控执行过程
4. **三种范式**：用 AgentX 实现 ReAct、Plan-and-Solve、Reflection
5. **配置选项**：了解可配置参数
6. **错误处理**：处理各种异常

AgentX 大幅简化了开发，同时保持灵活性和可控性。

下一节学习工具系统。

---

[⬅️ 上一节：核心概念](5.2-核心概念.md) | [🏠 返回目录](README.md) | [➡️ 下一节：工具系统](5.4-工具系统.md)
